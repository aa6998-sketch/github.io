<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flux AI éœ“è™¹ç¹ªåœ–ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #8b5cf6, #ec4899);
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #7c3aed, #db2777);
        }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Neon Glow Effects */
        .neon-text {
            text-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }
        
        .neon-border:focus-within {
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
            border-color: #8b5cf6;
        }

        /* Card Hover Glow */
        .image-card {
            transition: all 0.3s ease;
        }
        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(139, 92, 246, 0.4), 0 8px 10px -6px rgba(139, 92, 246, 0.1);
        }

        /* Loader Animation */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid #ec4899;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Button Gradients */
        .btn-gradient-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            transition: filter 0.2s;
        }
        .btn-gradient-primary:hover {
            filter: brightness(1.1);
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.5);
        }

        .btn-gradient-secondary {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        }
        .btn-gradient-secondary:hover {
            filter: brightness(1.1);
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #ec4899;
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 0 10px #ec4899;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center">

    <!-- Notification Toast Container -->
    <div id="notification-container" class="fixed top-5 right-5 z-50 flex flex-col gap-3"></div>

    <!-- Hidden File Input for Custom Music -->
    <input type="file" id="musicFile" accept="audio/*" class="hidden" onchange="handleMusicUpload(this)">

    <!-- Main Container -->
    <main class="w-full max-w-6xl glass-panel rounded-3xl overflow-hidden flex flex-col min-h-[85vh]">
        
        <!-- Header -->
        <header class="p-6 md:p-8 border-b border-white/10 bg-gradient-to-r from-slate-900/80 to-purple-900/80">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-pink-500 to-violet-600 flex items-center justify-center shadow-lg shadow-purple-500/30">
                        <i class="fa-solid fa-wand-magic-sparkles text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-400 to-violet-400 neon-text">äººè±ªè€å¸«çš„AIç”Ÿåœ–æ©Ÿ</h1>
                        <p class="text-xs text-slate-400 tracking-wider uppercase">Advanced Image Generation</p>
                    </div>
                    
                    <!-- Music Controls -->
                    <div class="flex items-center gap-2 ml-2">
                        <button onclick="document.getElementById('musicFile').click()" class="w-8 h-8 rounded-full bg-white/5 border border-white/10 hover:bg-violet-500 hover:border-violet-500 flex items-center justify-center transition text-slate-400 hover:text-white" title="é¸æ“‡æœ¬æ©ŸéŸ³æ¨‚æª”æ¡ˆ (å¦‚: My Project.m4a)">
                            <i class="fa-solid fa-folder-open"></i>
                        </button>
                        <button id="musicToggle" onclick="toggleMusic()" class="w-8 h-8 rounded-full bg-white/5 border border-white/10 hover:bg-pink-500 hover:border-pink-500 flex items-center justify-center transition text-slate-400 hover:text-white group" title="æ’­æ”¾/æš«åœéŸ³æ¨‚">
                            <i class="fa-solid fa-music group-[.playing]:animate-spin-slow"></i>
                        </button>
                    </div>
                </div>
                <div class="flex gap-3 text-sm">
                    <span class="px-3 py-1 rounded-full bg-white/5 border border-white/10 text-slate-300">
                        <i class="fa-solid fa-bolt text-yellow-400 mr-1"></i> Fast
                    </span>
                    <span class="px-3 py-1 rounded-full bg-white/5 border border-white/10 text-slate-300">
                        <i class="fa-solid fa-image text-pink-400 mr-1"></i> High Res
                    </span>
                </div>
            </div>
        </header>

        <div class="flex flex-col lg:flex-row flex-1">
            
            <!-- Controls Sidebar -->
            <aside class="w-full lg:w-1/3 p-6 md:p-8 border-b lg:border-b-0 lg:border-r border-white/10 flex flex-col gap-6 bg-slate-900/30">
                
                <!-- Prompt Input Section -->
                <div class="space-y-3">
                    <div class="flex justify-between items-end">
                        <label class="text-sm font-medium text-slate-300"><i class="fa-solid fa-keyboard mr-2 text-pink-500"></i>æç¤ºè© (Prompt)</label>
                        <div class="flex gap-1">
                            <button onclick="randomPrompt()" class="text-xs px-2 py-1 rounded bg-white/5 hover:bg-white/10 text-cyan-400 transition" title="éš¨æ©Ÿéˆæ„Ÿ">
                                <i class="fa-solid fa-dice"></i> éˆæ„Ÿ
                            </button>
                            <button onclick="clearPrompt()" class="text-xs px-2 py-1 rounded bg-white/5 hover:bg-white/10 text-slate-400 hover:text-red-400 transition" title="æ¸…ç©º">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="relative group">
                        <textarea id="promptInput" rows="4" 
                            class="w-full bg-slate-950/50 border border-white/10 rounded-xl p-4 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-violet-500 focus:ring-1 focus:ring-violet-500 transition resize-none neon-border"
                            placeholder="æè¿°ä½ æƒ³çœ‹åˆ°çš„ç•«é¢...ä¾‹å¦‚ï¼šä¸€å€‹åœ¨é›¨ä¸­æ¼«æ­¥çš„è³½åšæœ‹å…‹æ©Ÿå™¨äºº"></textarea>
                        <button onclick="enhancePrompt()" class="absolute bottom-3 right-3 text-xs px-3 py-1.5 rounded-lg bg-gradient-to-r from-emerald-500 to-teal-600 text-white shadow-lg hover:shadow-emerald-500/20 transition opacity-80 hover:opacity-100">
                            <i class="fa-solid fa-wand-magic mr-1"></i> ç¾åŒ–æè¿°
                        </button>
                    </div>
                </div>

                <!-- Settings Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 gap-6">
                    
                    <!-- Art Style -->
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-300"><i class="fa-solid fa-palette mr-2 text-violet-500"></i>è—è¡“é¢¨æ ¼</label>
                        <div class="relative">
                            <select id="styleSelect" class="w-full appearance-none bg-slate-950/50 border border-white/10 rounded-xl px-4 py-3 text-sm text-slate-200 focus:outline-none focus:border-violet-500 cursor-pointer">
                                <option value="">âœ¨ é è¨­ (ç„¡é¢¨æ ¼)</option>
                                <option value="anime style, highly detailed">ğŸŒ¸ æ—¥æœ¬å‹•æ¼«é¢¨</option>
                                <option value="studio ghibli style, vibrant colors">ğŸŒ¿ å‰åœåŠ›å·¥ä½œå®¤</option>
                                <option value="classic cartoon style, flat colors">ğŸª å¡é€šé¢¨æ ¼</option>
                                <option value="watercolor painting, artistic">ğŸ–Œï¸ æ°´å½©ç•«</option>
                                <option value="oil painting, textured">ğŸ¨ æ²¹ç•«é¢¨æ ¼</option>
                                <option value="digital art, trending on artstation">ğŸ’» æ•¸ä½è—è¡“</option>
                                <option value="photorealistic, 8k, ultra detailed">ğŸ“· å¯«å¯¦é¢¨æ ¼</option>
                                <option value="black and white sketch, charcoal">âœï¸ é»‘ç™½ç´ æ</option>
                                <option value="colored pencil drawing">ğŸ–ï¸ è‰²é‰›ç­†</option>
                                <option value="cyberpunk, neon lights, futuristic">ğŸŒƒ è³½åšæœ‹å…‹</option>
                                <option value="80s retro style, synthwave, vhs effect">ğŸ“¼ å¾©å¤é¢¨æ ¼</option>
                            </select>
                            <div class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none">
                                <i class="fa-solid fa-chevron-down"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Size Selection -->
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-300"><i class="fa-solid fa-expand mr-2 text-blue-500"></i>å°ºå¯¸å®šç¾©</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="setSize(1920, 1080, this)" class="size-btn active p-2 rounded-lg border border-white/10 bg-white/5 hover:bg-violet-500/20 text-xs text-slate-300 flex items-center justify-center gap-2 transition group" data-w="1920" data-h="1080">
                                <i class="fa-solid fa-desktop group-[.active]:text-violet-400"></i> 1920Ã—1080
                            </button>
                            <button onclick="setSize(1080, 1920, this)" class="size-btn p-2 rounded-lg border border-white/10 bg-white/5 hover:bg-violet-500/20 text-xs text-slate-300 flex items-center justify-center gap-2 transition group" data-w="1080" data-h="1920">
                                <i class="fa-solid fa-mobile-screen group-[.active]:text-violet-400"></i> 1080Ã—1920
                            </button>
                            <button onclick="setSize(1024, 1024, this)" class="size-btn p-2 rounded-lg border border-white/10 bg-white/5 hover:bg-violet-500/20 text-xs text-slate-300 flex items-center justify-center gap-2 transition group" data-w="1024" data-h="1024">
                                <i class="fa-solid fa-square group-[.active]:text-violet-400"></i> 1024Ã—1024
                            </button>
                            <button onclick="setSize(512, 768, this)" class="size-btn p-2 rounded-lg border border-white/10 bg-white/5 hover:bg-violet-500/20 text-xs text-slate-300 flex items-center justify-center gap-2 transition group" data-w="512" data-h="768">
                                <i class="fa-solid fa-file group-[.active]:text-violet-400"></i> 512Ã—768
                            </button>
                        </div>
                    </div>

                    <!-- Batch Count -->
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <label class="text-sm font-medium text-slate-300"><i class="fa-solid fa-layer-group mr-2 text-orange-500"></i>ç”Ÿæˆæ•¸é‡</label>
                            <span id="batchCountDisplay" class="text-xs font-bold text-violet-400 bg-violet-500/10 px-2 py-0.5 rounded">1 å¼µ</span>
                        </div>
                        <input type="range" id="batchCount" min="1" max="4" value="1" class="w-full" oninput="updateBatchDisplay(this.value)">
                        <div class="flex justify-between text-[10px] text-slate-500 px-1">
                            <span>1</span>
                            <span>2</span>
                            <span>3</span>
                            <span>4</span>
                        </div>
                    </div>

                </div>

                <!-- Generate Button -->
                <div class="mt-auto pt-4">
                    <button id="generateBtn" onclick="generateImages()" class="w-full py-4 rounded-xl btn-gradient-primary text-white font-bold text-lg shadow-lg shadow-purple-500/20 flex items-center justify-center gap-3 relative overflow-hidden group">
                        <span class="relative z-10 flex items-center gap-2">
                            <i class="fa-solid fa-rocket"></i> é–‹å§‹ç”Ÿæˆåœ–åƒ
                        </span>
                        <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                    </button>
                </div>

            </aside>

            <!-- Preview & History Area -->
            <section class="flex-1 flex flex-col min-h-[500px] bg-black/20">
                
                <!-- Tabs -->
                <div class="flex border-b border-white/10 px-6 pt-4">
                    <button onclick="switchTab('gallery')" id="tab-gallery" class="px-6 py-3 text-sm font-medium border-b-2 border-violet-500 text-violet-400 transition hover:text-violet-300">
                        <i class="fa-solid fa-images mr-2"></i>ç”Ÿæˆé è¦½
                    </button>
                    <button onclick="switchTab('history')" id="tab-history" class="px-6 py-3 text-sm font-medium border-b-2 border-transparent text-slate-400 transition hover:text-slate-200 hover:border-slate-700">
                        <i class="fa-solid fa-clock-rotate-left mr-2"></i>æ­·å²ç´€éŒ„
                    </button>
                    <div class="ml-auto flex items-center">
                         <span id="statusText" class="text-xs text-slate-500 hidden md:block">æº–å‚™å°±ç·’</span>
                    </div>
                </div>

                <!-- Content Area -->
                <div class="flex-1 p-6 overflow-y-auto relative custom-scrollbar">
                    
                    <!-- Gallery View -->
                    <div id="gallery-view" class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-20">
                        <!-- Empty State -->
                        <div id="empty-state" class="col-span-full flex flex-col items-center justify-center h-64 md:h-96 text-slate-600 border-2 border-dashed border-white/5 rounded-2xl">
                            <i class="fa-solid fa-paintbrush text-4xl mb-4 opacity-50"></i>
                            <p class="text-lg">å°šæœªç”Ÿæˆä»»ä½•åœ–åƒ</p>
                            <p class="text-sm opacity-60">åœ¨å·¦å´è¼¸å…¥æç¤ºè©ä¸¦é»æ“Šç”Ÿæˆ</p>
                        </div>
                        <!-- Images will be injected here -->
                    </div>

                    <!-- History View -->
                    <div id="history-view" class="hidden grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 pb-20">
                        <!-- History items injected here -->
                    </div>

                </div>
            </section>
        </div>
    </main>

    <footer class="mt-6 text-slate-500 text-xs text-center pb-6">
        <p>Powered by <span class="text-violet-400">Pollinations.ai</span> & Flux Model</p>
    </footer>

    <!-- Background Music -->
    <!-- Using a reliable public domain URL as initial fallback, user can upload their own -->
    <audio id="bgMusic" loop>
        <!-- Switched to a more "funny/relaxed" style track -->
        <source src="https://cdn.pixabay.com/audio/2022/03/15/audio_b202029929.mp3" type="audio/mpeg">
        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ audio å…ƒç´ ã€‚
    </audio>

    <script>
        // State
        let currentWidth = 1920;
        let currentHeight = 1080;
        const historyKey = 'flux_neon_history_v1';
        let generationHistory = JSON.parse(localStorage.getItem(historyKey)) || [];

        // Constants
        const randomPrompts = [
            "A futuristic city with flying cars and neon lights, cyberpunk style",
            "A serene japanese garden with cherry blossoms falling, ghibli style",
            "An astronaut playing chess with an alien on Mars, realistic",
            "A cute cat wizard casting a spell, digital art",
            "A steampunk airship floating above the clouds, oil painting",
            "A dragon made of crystals and light, fantasy art",
            "A post-apocalyptic landscape reclaimed by nature, cinematic",
            "A detective standing in the rain, noir style black and white"
        ];

        const adjectives = [
            "highly detailed", "8k resolution", "cinematic lighting", 
            "masterpiece", "vibrant colors", "sharp focus", 
            "intricate details", "dramatic atmosphere", "trending on artstation"
        ];

        // Initialization
        window.addEventListener('DOMContentLoaded', () => {
            renderHistory();
            
            // Add style for active size button
            document.querySelectorAll('.size-btn').forEach(btn => {
                if(btn.dataset.w == 1920) btn.classList.add('bg-violet-500/20', 'border-violet-500/50', 'text-white');
            });

            // Music Error Handling
            const audio = document.getElementById('bgMusic');
            audio.addEventListener('error', function(e) {
                console.log("Audio Error:", e);
                showNotification('é è¨­éŸ³æ¨‚è¼‰å…¥å¤±æ•—ï¼Œè«‹å˜—è©¦ä½¿ç”¨ã€Œä¸Šå‚³éŸ³æ¨‚ã€åŠŸèƒ½', 'error');
            });
        });

        // Music Control & Upload
        function toggleMusic() {
            const audio = document.getElementById('bgMusic');
            const btn = document.getElementById('musicToggle');
            const icon = btn.querySelector('i');
            
            if (audio.paused) {
                audio.volume = 0.5; // Set volume to 50%
                audio.play().then(() => {
                    btn.classList.add('bg-pink-500', 'border-pink-500', 'text-white', 'playing');
                    btn.classList.remove('bg-white/5', 'text-slate-400');
                    icon.classList.remove('fa-music');
                    icon.classList.add('fa-pause');
                    showNotification('ğŸµ éŸ³æ¨‚é–‹å§‹æ’­æ”¾');
                }).catch(e => {
                    console.log("Audio play failed", e);
                    showNotification('ç„¡æ³•æ’­æ”¾ï¼Œè«‹é»æ“Šè³‡æ–™å¤¾åœ–ç¤ºè¼‰å…¥æ‚¨çš„éŸ³æ¨‚æª”æ¡ˆ', 'error');
                });
            } else {
                audio.pause();
                btn.classList.remove('bg-pink-500', 'border-pink-500', 'text-white', 'playing');
                btn.classList.add('bg-white/5', 'text-slate-400');
                icon.classList.remove('fa-pause');
                icon.classList.add('fa-music');
                showNotification('ğŸ”‡ éŸ³æ¨‚å·²æš«åœ');
            }
        }

        function handleMusicUpload(input) {
            const file = input.files[0];
            if (file) {
                const audio = document.getElementById('bgMusic');
                const btn = document.getElementById('musicToggle');
                
                // Create object URL for the uploaded file
                const fileUrl = URL.createObjectURL(file);
                
                audio.src = fileUrl;
                audio.load();
                
                // Auto play
                audio.play().then(() => {
                    btn.classList.add('bg-pink-500', 'border-pink-500', 'text-white', 'playing');
                    btn.classList.remove('bg-white/5', 'text-slate-400');
                    const icon = btn.querySelector('i');
                    icon.classList.remove('fa-music');
                    icon.classList.add('fa-pause');
                    showNotification(`ğŸµ å·²è¼‰å…¥: ${file.name}`);
                }).catch(e => {
                    showNotification('éŸ³æ¨‚è¼‰å…¥æˆåŠŸï¼Œè«‹é»æ“Šæ’­æ”¾', 'success');
                });
            }
        }

        // UI Helpers
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notif = document.createElement('div');
            
            let bgClass = type === 'success' 
                ? 'bg-gradient-to-r from-emerald-900/90 to-teal-900/90 border-emerald-500/30' 
                : 'bg-gradient-to-r from-red-900/90 to-pink-900/90 border-red-500/30';
            let iconClass = type === 'success' ? 'fa-check-circle text-emerald-400' : 'fa-circle-exclamation text-red-400';

            notif.className = `transform transition-all duration-300 translate-x-full opacity-0 p-4 rounded-xl border shadow-lg backdrop-blur-md flex items-center gap-3 min-w-[280px] ${bgClass}`;
            notif.innerHTML = `
                <i class="fa-solid ${iconClass}"></i>
                <span class="text-sm font-medium text-white">${message}</span>
            `;

            container.appendChild(notif);

            // Animate in
            requestAnimationFrame(() => {
                notif.classList.remove('translate-x-full', 'opacity-0');
            });

            // Remove after 3s
            setTimeout(() => {
                notif.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        function switchTab(tabName) {
            const galleryView = document.getElementById('gallery-view');
            const historyView = document.getElementById('history-view');
            const tabGallery = document.getElementById('tab-gallery');
            const tabHistory = document.getElementById('tab-history');

            if (tabName === 'gallery') {
                galleryView.classList.remove('hidden');
                historyView.classList.add('hidden');
                
                tabGallery.className = "px-6 py-3 text-sm font-medium border-b-2 border-violet-500 text-violet-400 transition hover:text-violet-300";
                tabHistory.className = "px-6 py-3 text-sm font-medium border-b-2 border-transparent text-slate-400 transition hover:text-slate-200 hover:border-slate-700";
            } else {
                galleryView.classList.add('hidden');
                historyView.classList.remove('hidden');
                renderHistory();

                tabGallery.className = "px-6 py-3 text-sm font-medium border-b-2 border-transparent text-slate-400 transition hover:text-slate-200 hover:border-slate-700";
                tabHistory.className = "px-6 py-3 text-sm font-medium border-b-2 border-violet-500 text-violet-400 transition hover:text-violet-300";
            }
        }

        function updateBatchDisplay(val) {
            document.getElementById('batchCountDisplay').innerText = val + " å¼µ";
        }

        function setSize(w, h, btnElement) {
            currentWidth = w;
            currentHeight = h;
            
            // Reset all buttons
            document.querySelectorAll('.size-btn').forEach(btn => {
                btn.classList.remove('bg-violet-500/20', 'border-violet-500/50', 'text-white', 'active');
                btn.classList.add('bg-white/5', 'text-slate-300');
                btn.querySelector('i').classList.remove('text-violet-400');
            });

            // Set active button
            btnElement.classList.remove('bg-white/5', 'text-slate-300');
            btnElement.classList.add('bg-violet-500/20', 'border-violet-500/50', 'text-white', 'active');
            btnElement.querySelector('i').classList.add('text-violet-400');
        }

        // Prompt Helpers
        function randomPrompt() {
            const prompt = randomPrompts[Math.floor(Math.random() * randomPrompts.length)];
            document.getElementById('promptInput').value = prompt;
            // Add a little flash effect
            const input = document.getElementById('promptInput');
            input.classList.add('ring-2', 'ring-cyan-500');
            setTimeout(() => input.classList.remove('ring-2', 'ring-cyan-500'), 300);
        }

        function clearPrompt() {
            document.getElementById('promptInput').value = '';
            document.getElementById('promptInput').focus();
        }

        function enhancePrompt() {
            let current = document.getElementById('promptInput').value.trim();
            if (!current) {
                showNotification('è«‹å…ˆè¼¸å…¥ä¸€äº›æ–‡å­—', 'error');
                return;
            }
            
            // Pick 2 random adjectives
            const shuffled = adjectives.sort(() => 0.5 - Math.random());
            const additions = shuffled.slice(0, 2).join(", ");
            
            document.getElementById('promptInput').value = `${current}, ${additions}`;
            showNotification('æè¿°å·²ç¾åŒ– âœ¨');
        }

        // Core Generation Logic
        async function generateImages() {
            const rawPrompt = document.getElementById('promptInput').value.trim();
            if (!rawPrompt) {
                showNotification('è«‹è¼¸å…¥æç¤ºè©ï¼', 'error');
                document.getElementById('promptInput').focus();
                return;
            }

            const style = document.getElementById('styleSelect').value;
            const count = parseInt(document.getElementById('batchCount').value);
            const btn = document.getElementById('generateBtn');
            const gallery = document.getElementById('gallery-view');
            const emptyState = document.getElementById('empty-state');
            const statusText = document.getElementById('statusText');

            // Combine prompt and style
            const finalPrompt = style ? `${rawPrompt}, ${style}` : rawPrompt;

            // UI Loading State
            btn.disabled = true;
            btn.innerHTML = `<div class="loader mr-2"></div> ç”Ÿæˆä¸­...`;
            statusText.innerText = "æ­£åœ¨è¯çµ¡ AI æ¨¡å‹...";
            
            if(emptyState) emptyState.classList.add('hidden');
            
            // Clear previous gallery ONLY if we want fresh batch, 
            // but let's prepend to keep recent context or clear? 
            // User requirement: "Batch preview". Let's clear gallery for new batch to be clean.
            gallery.innerHTML = '';

            try {
                for (let i = 0; i < count; i++) {
                    const seed = Math.floor(Math.random() * 1000000);
                    // Encode prompt for URL
                    const encodedPrompt = encodeURIComponent(finalPrompt);
                    const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=${currentWidth}&height=${currentHeight}&seed=${seed}&model=flux&nologo=true`;

                    // Create Card Skeleton
                    const cardId = `img-${Date.now()}-${i}`;
                    const cardHTML = `
                        <div class="image-card bg-slate-900/50 rounded-2xl overflow-hidden border border-white/10 group relative aspect-[${currentWidth}/${currentHeight}] flex items-center justify-center">
                            <div class="absolute inset-0 flex items-center justify-center z-0 loading-placeholder">
                                <div class="loader border-violet-500 border-t-transparent"></div>
                            </div>
                            <img 
                                src="${imageUrl}" 
                                alt="${finalPrompt}" 
                                class="w-full h-full object-cover relative z-10 opacity-0 transition-opacity duration-500"
                                onload="this.style.opacity='1'; this.previousElementSibling.remove();"
                                onerror="this.src='https://placehold.co/600x400?text=Error'; this.style.opacity='1';"
                            >
                            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-20 flex flex-col justify-end p-4">
                                <p class="text-white text-xs line-clamp-2 mb-3 font-light">${finalPrompt}</p>
                                <div class="flex gap-2">
                                    <button onclick="downloadImage('${imageUrl}')" class="flex-1 bg-white/10 hover:bg-white/20 backdrop-blur-md text-white text-xs py-2 rounded-lg transition border border-white/10">
                                        <i class="fa-solid fa-download mr-1"></i> ä¸‹è¼‰
                                    </button>
                                    <button onclick="window.open('${imageUrl}', '_blank')" class="bg-violet-500/80 hover:bg-violet-500 text-white px-3 rounded-lg transition">
                                        <i class="fa-solid fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    gallery.insertAdjacentHTML('beforeend', cardHTML);

                    // Save to history
                    addToHistory(imageUrl, finalPrompt, seed);
                }

                showNotification(`æˆåŠŸç”Ÿæˆ ${count} å¼µåœ–åƒï¼`);
                statusText.innerText = "ç”Ÿæˆå®Œæˆ";

            } catch (error) {
                console.error(error);
                showNotification('ç”Ÿæˆéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<span class="relative z-10 flex items-center gap-2"><i class="fa-solid fa-rocket"></i> é–‹å§‹ç”Ÿæˆåœ–åƒ</span><div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>`;
            }
        }

        // History Management
        function addToHistory(url, prompt, seed) {
            const item = {
                url: url,
                prompt: prompt,
                seed: seed,
                date: new Date().toLocaleTimeString()
            };
            
            // Add to beginning
            generationHistory.unshift(item);
            
            // Limit to last 50
            if (generationHistory.length > 50) {
                generationHistory.pop();
            }

            localStorage.setItem(historyKey, JSON.stringify(generationHistory));
        }

        function renderHistory() {
            const container = document.getElementById('history-view');
            container.innerHTML = '';

            if (generationHistory.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center h-64 text-slate-600">
                        <i class="fa-solid fa-clock-rotate-left text-3xl mb-3 opacity-50"></i>
                        <p class="text-sm">æš«ç„¡æ­·å²ç´€éŒ„</p>
                    </div>
                `;
                return;
            }

            generationHistory.forEach(item => {
                const el = document.createElement('div');
                el.className = 'group relative rounded-xl overflow-hidden border border-white/5 bg-slate-900/40 aspect-square';
                el.innerHTML = `
                    <img src="${item.url}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110" loading="lazy">
                    <div class="absolute inset-0 bg-black/80 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex flex-col items-center justify-center gap-2 p-2 text-center">
                        <p class="text-[10px] text-slate-300 line-clamp-2 px-1">${item.prompt}</p>
                        <div class="flex gap-2 mt-1">
                             <button onclick="downloadImage('${item.url}')" class="text-xs w-8 h-8 rounded-full bg-white/10 hover:bg-violet-500 text-white flex items-center justify-center transition">
                                <i class="fa-solid fa-download"></i>
                            </button>
                            <button onclick="window.open('${item.url}', '_blank')" class="text-xs w-8 h-8 rounded-full bg-white/10 hover:bg-pink-500 text-white flex items-center justify-center transition">
                                <i class="fa-solid fa-external-link-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        async function downloadImage(url) {
            try {
                showNotification('æº–å‚™ä¸‹è¼‰...', 'success');
                const response = await fetch(url);
                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = `flux-neon-${Date.now()}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(blobUrl);
            } catch (e) {
                showNotification('ä¸‹è¼‰å¤±æ•—ï¼Œè«‹å˜—è©¦åœ¨æ–°åˆ†é é–‹å•Ÿ', 'error');
                window.open(url, '_blank');
            }
        }
    </script>
</body>
</html>